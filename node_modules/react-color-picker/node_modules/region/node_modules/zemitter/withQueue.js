'use strict'

var withQueueStates = require('./withQueueStates')

module.exports = function(name, fn, stateName, QUEUE, config){

    var skipEmpty = !!(config && config.skipEmpty)
    var result = false

    withQueueStates.call(this, function(allStates, Q){
        if (skipEmpty && !allStates[name]){
            return
        }

        result = this

        var state = allStates[name] || {}

        // restore the queue with the state for the given name
        Q.from(state)

        fn.call(this, Q)

        //save the queue state

        state = Q.toStateObject()

        if (state !== undefined){
            allStates[name] = state
        } else {
            delete allStates[name]
        }

    }, stateName, QUEUE)

    return result
}