'use strict'

var FunctionQueue = require('fn-queue')

var Q = new FunctionQueue({
    allowFunctionsAsString: true,
    keepFunctionReferences: true
})

module.exports = function(fn, stateName, QUEUE){

    QUEUE = QUEUE || Q

    this[stateName] = this[stateName] || {}

    var prevQueueState = QUEUE.toStateObject()

    if (fn){
        fn.call(this, this[stateName], QUEUE)
    }

    //restore the queue back to its original state
    QUEUE.from(prevQueueState)

    return this
}